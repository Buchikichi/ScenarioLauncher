Math.PI2=Math.PI2||Math.PI*2;Math.SQ=Math.SQ||Math.PI/2;Math.trim=Math.trim||function(b){var a=b;while(Math.PI<a){a-=Math.PI2}while(a<-Math.PI){a+=Math.PI2}return a};Math.close=Math.close||function(d,c,b){var a=Math.trim(d-c);if(Math.abs(a)<=b){return d}if(0<a){return d-b}return d+b};function Matrix(a){this.mat=a}Matrix.NO_EFFECT=new Matrix([[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]);Matrix.rotateX=function(a){return new Matrix([[1,0,0,0],[0,Math.cos(a),-Math.sin(a),0],[0,Math.sin(a),Math.cos(a),0],[0,0,0,1]])};Matrix.rotateY=function(a){return new Matrix([[Math.cos(a),0,Math.sin(a),0],[0,1,0,0],[-Math.sin(a),0,Math.cos(a),0],[0,0,0,1]])};Matrix.rotateZ=function(a){return new Matrix([[Math.cos(a),-Math.sin(a),0,0],[Math.sin(a),Math.cos(a),0,0],[0,0,1,0],[0,0,0,1]])};Matrix.prototype.multiply=function(c){var b=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];var a=c.mat;this.mat.forEach(function(e,d){e.forEach(function(g,f){var i=0;for(var h=0;h<4;h++){i+=e[h]*a[h][f]}b[d][f]=i})});return new Matrix(b)};Matrix.prototype.affine=function(c,g,e){var b=this.mat;var a=b[0][0]*c+b[0][1]*g+b[0][2]*e+b[0][3];var f=b[1][0]*c+b[1][1]*g+b[1][2]*e+b[1][3];var d=b[2][0]*c+b[2][1]*g+b[2][2]*e+b[2][3];return{x:a,y:f,z:d}};function Anima(a){var b=this;this.skeleton=new Skeleton(a.skeleton);this.motion=[];a.motion.forEach(function(d){var c=[];d.forEach(function(k,i){var m=Matrix.NO_EFFECT;var g=Matrix.rotateX(k[0]);var f=Matrix.rotateY(k[1]);var e=Matrix.rotateZ(k[2]);var h=b.skeleton.list[i];var j=h.order.split("");j.forEach(function(n){if(n=="x"){m=m.multiply(g)}else{if(n=="y"){m=m.multiply(f)}else{if(n=="z"){m=m.multiply(e)}}}});var l={rotate:m};if(3<k.length){l.tx=k[3];l.ty=k[4];l.tz=k[5]}c.push(l)});b.motion.push(c)})}Anima.prototype.rotateH=function(a){this.skeleton.rotationH=a;this.skeleton.calcRotationMatrix()};Anima.prototype.rotateV=function(a){this.skeleton.rotationV=a;this.skeleton.calcRotationMatrix()};Anima.prototype.shift=function(b,c){var a=b%this.motion.length;this.skeleton.shift(this.motion[a],c)};Anima.prototype.calculate=function(a){this.skeleton.calculate(a)};Anima.prototype.draw=function(a){this.skeleton.draw(a)};function Skeleton(a){this.data=a;this.calcOrder=this.data.calcOrder=="RotateTranslate"?0:1;this.list=[];this.map={};this.offsetX=0;this.offsetY=0;this.rotationH=Math.PI/4;this.rotationV=Math.PI/8;this.rotationMatrix=Matrix.NO_EFFECT;this.init()}Skeleton.prototype.init=function(){var a=Object.assign(new Bone(),this.data.root);this.data.root=a;this.prepare(a);this.calcRotationMatrix()};Skeleton.prototype.prepare=function(b){var c=this;var a=[];this.list.push(b);b.prepare();b.joint.forEach(function(d){d.parent=b;a.push(Object.assign(new Bone(),d))});b.joint=a;b.joint.forEach(function(d){c.prepare(d)});b.skeleton=this;this.map[b.name]=b};Skeleton.prototype.calcRotationMatrix=function(){var a=Matrix.rotateY(this.rotationH);this.rotationMatrix=Matrix.rotateX(this.rotationV).multiply(a)};Skeleton.prototype.shift=function(a,c){var b=this;a.forEach(function(f,e){var h=b.list[e];h.motionMatrix=f.rotate;if(f.tx){var g=h.pt;var d=b.offsetX+g.x+f.tx*c;var j=b.offsetY+g.y+f.ty*c;var i=g.z+f.tz*c;h.translateMatrix=new Matrix([[1,0,0,d],[0,1,0,j],[0,0,1,i],[0,0,0,1]])}})};Skeleton.prototype.calculate=function(a){this.data.root.calculate(a)};Skeleton.prototype.draw=function(a){this.data.root.draw(a)};function Bone(){this.pt={x:0,y:0,z:0}}Bone.prototype.prepare=function(){var j=this.translate;var i=Matrix.rotateX(this.axis.x);var g=Matrix.rotateY(this.axis.y);var f=Matrix.rotateZ(this.axis.z);var e=f.multiply(g).multiply(i);this.translateMatrix=new Matrix([[1,0,0,j.x],[0,1,0,j.y],[0,0,1,j.z],[0,0,0,1]]);if(this.parent){var h=this.parent;var c=Matrix.rotateX(-h.axis.x);var b=Matrix.rotateY(-h.axis.y);var a=Matrix.rotateZ(-h.axis.z);var d=c.multiply(b).multiply(a);this.axisMatrix=d.multiply(e)}else{this.axisMatrix=e}this.motionMatrix=Matrix.NO_EFFECT};Bone.prototype.getAccum=function(){var a=this.skeleton.calcOrder;if(this.parent){var b;if(a==0){b=this.axisMatrix.multiply(this.motionMatrix).multiply(this.translateMatrix)}else{b=this.axisMatrix.multiply(this.translateMatrix).multiply(this.motionMatrix)}return this.parent.getAccum().multiply(b)}return this.translateMatrix.multiply(this.motionMatrix)};Bone.prototype.calculate=function(a){this.pt=this.getAccum().affine(0,0,0);if(a){return}this.joint.forEach(function(b){b.calculate(false)})};Bone.prototype.conv=function(c){c=this.skeleton.rotationMatrix.affine(c.x,c.y,c.z);var b=(c.z+2000)/2000;var a=new Matrix([[b,0,0,0],[0,b,0,0],[0,0,b,0],[0,0,0,1]]);return a.affine(c.x,c.y,c.z)};Bone.prototype.drawLine=function(f){var c=this.conv(this.parent.pt);var h=this.conv(this.pt);var g=h.x;var e=-h.y;var b=c.x;var a=-c.y;var i=g-b;var d=e-a;this.cx=b+i/2;this.cy=a+d/2;this.cz=h.z;this.radian=Math.atan2(d,i);f.beginPath();f.moveTo(b,a);f.lineTo(g,e);f.stroke()};Bone.prototype.draw=function(a){this.calculate();if(this.parent){this.drawLine(a)}this.joint.forEach(function(b){b.draw(a)})};function Field(){this.motionNo=0;this.rotationH=155*Math.PI/180;this.rotationV=Math.PI/8;this.animaList=[];this.init()}Field.WIDTH=960;Field.HEIGHT=540;Field.COLOR_LIST=["lightpink","palegreen","lightskyblue","orange"];Field.prototype.init=function(){var a=document.getElementById("canvas");this.ctx=a.getContext("2d")};Field.prototype.resetCanvas=function(b,a){this.width=b;this.height=a;this.hW=this.width/2;this.hH=this.height/2;this.scale=b/Field.WIDTH;$("#canvas").attr("width",this.width).attr("height",this.height)};Field.prototype.loadMotion=function(a){var c=this;var b=$("#slider");c.shiftMotion(0);b.val(0).slider("refresh");return $.ajax("dat/"+a,{dataType:"json",success:function(d){console.log("motions:"+d.motion.length);c.animaList.push(new Anima(d));c.resetMotion();b.prop("max",d.motion.length-1);b.slider("refresh")}})};Field.prototype.resetMotion=function(){var a=this;this.shiftMotion(0);this.rotateH(0);this.rotateV(0);this.draw()};Field.prototype.shiftMotion=function(a){var c=this;var b=a<this.motionNo?-1:1;while(this.motionNo!=a){if(0<b){this.motionNo+=b}this.animaList.forEach(function(d){d.shift(c.motionNo,b);d.calculate(c.motionNo!=a)});if(b<0){this.motionNo+=b}}};Field.prototype.nextMotion=function(a){var a=this.motionNo;a++;this.shiftMotion(a)};Field.prototype.rotateH=function(c){var b=this;this.rotationH+=(Math.PI/720)*c;this.rotationH=Math.trim(this.rotationH);this.animaList.forEach(function(d){d.rotateH(b.rotationH)});var a=Math.abs(this.rotationH/Math.PI);AudioMixer.INSTANCE.panNode.pan.value=a};Field.prototype.rotateV=function(b){var a=this;this.rotationV+=(Math.PI/720)*b;this.rotationV=Math.trim(this.rotationV);this.animaList.forEach(function(c){c.rotateV(a.rotationV)})};Field.prototype.draw=function(){var b=this.ctx;var a=Field.COLOR_LIST.length;b.clearRect(0,0,this.width,this.height);b.save();b.strokeStyle="rgba(255, 255, 255, .7)";b.strokeText("H:"+Math.floor(this.rotationH*180/Math.PI),2,20);b.strokeText("V:"+Math.floor(this.rotationV*180/Math.PI),2,30);b.strokeText("m:"+this.motionNo,2,40);b.translate(this.hW,this.hH);b.scale(this.scale,this.scale);b.lineCap="round";this.animaList.forEach(function(d,c){b.strokeStyle=Field.COLOR_LIST[c%a];d.draw(b)});b.restore()};function Repository(){this.max=0;this.loaded=0;this.dic={};this.type="json"}Repository.prototype.isComplete=function(){return 0<this.max&&this.max==this.loaded};Repository.prototype.reserve=function(b){var a=this;b.forEach(function(c){a.load(c)})};Repository.prototype.makeName=function(a){return a};Repository.prototype.load=function(b){var c=this;var d=new XMLHttpRequest();var a=this.makeName(b);this.max++;d.open("GET",a,true);d.responseType=this.type;d.addEventListener("load",function(){var e=d.response;c.dic[b]=e;c.onload(b,a,e);c.loaded++});d.send()};Repository.prototype.onload=function(b,a,c){};"use strict";function AudioMixer(){Repository.apply(this,arguments);this.type="arraybuffer";if(window.AudioContext||window.webkitAudioContext){this.ctx=new (window.AudioContext||window.webkitAudioContext)();this.gainNode=this.ctx.createGain();this.panNode=this.ctx.createStereoPanner()}this.dic=[];this.bgm=null;this.source=null;this.lastTime=null}AudioMixer.prototype=Object.create(Repository.prototype);AudioMixer.INSTANCE=new AudioMixer();AudioMixer.prototype.makeName=function(a){return"audio/"+a+".mp3"};AudioMixer.prototype.onload=function(c,b,e){var a=this.ctx;var d=this.dic;a.decodeAudioData(e,function(f){d[c]=f})};AudioMixer.prototype.play=function(c){if(!this.dic[c]){return}var b=this;var a=arguments.length;var d=1<a?arguments[1]:1;var f=2<a?arguments[2]:false;var g=3<a?arguments[3]:0;var h=this.dic[c];var e=this.ctx.createBufferSource();if(f){this.stop();console.log("d:"+h.duration);e.loopEnd=h.duration+10;e.loop=false;this.bgm=this.gainNode}this.gainNode.gain.value=d;this.gainNode.connect(this.ctx.destination);this.panNode.pan.value=g;this.panNode.connect(this.gainNode);e.buffer=h;e.connect(this.panNode);e.start(0);e.onended=function(){b.lastTime=null};this.source=e;this.lastTime=this.ctx.currentTime};AudioMixer.prototype.fade=function(){if(this.bgm==null){return}var a=this;var b=this.bgm.gain;var c=b.value;var d=function(){if(Math.floor(c*100)==0){a.source.stop();return}c*=0.8;b.value=c;setTimeout(d,100)};d()};AudioMixer.prototype.stop=function(){if(this.bgm==null){return}this.bgm.disconnect();this.bgm=null};AudioMixer.prototype.getCurrentTime=function(){if(!this.lastTime){return null}return this.ctx.currentTime-this.lastTime};AudioMixer.prototype.setCurrentTime=function(a){if(this.source){this.lastTime=a}};document.addEventListener("DOMContentLoaded",function(){var j=$("#view");var c=$("#slider");var k=new Field();var f=0;var d=0;var h=0;var a=function(){var m=$("body");var p=$("#header");var o=$("#footer");var n=m.width();var l=m.height()-p.outerHeight(true)-o.outerHeight(true)-16;if(l/9<n/16){n=parseInt(l/9*16)}else{l=parseInt(n/16*9)}k.resetCanvas(n,l)};var b=function(n){var l=n.type.match(/^mouse/);if(l){f=n.pageX;d=n.pageY}else{if(n.originalEvent.touches){var m=n.originalEvent.touches[0];f=m.pageX;d=m.pageY}}h=n.which};var i=function(r){var o=r.type.match(/^mouse/);var m;var l;if(o){if(!h){return}m=r.pageX;l=r.pageY}else{if(r.originalEvent.touches){var q=r.originalEvent.touches[0];m=q.pageX;l=q.pageY}}var p=f-m;var n=d-l;k.rotateH(p);k.rotateV(n);f=m;d=l};var e=function(l){h=0};var g=function(){var l=AudioMixer.INSTANCE.getCurrentTime();if(l){var m=parseInt(l/0.025);k.shiftMotion(m);c.val(m);c.slider("refresh")}k.draw();setTimeout(g,33)};setupFileList(k);j.mousedown(b);j.mousemove(i);j.mouseleave(e);j.mouseup(e);j.bind("touchstart",b);j.bind("touchmove",i);j.bind("touchend",e);c.change(function(){var m=$(this).val();var l=m*0.025;k.shiftMotion(m);AudioMixer.INSTANCE.setCurrentTime(l)});$(window).resize(a);g();$(window).resize();$("#playButton").click(function(){var l=AudioMixer.INSTANCE.getCurrentTime();if(l){AudioMixer.INSTANCE.fade();return}AudioMixer.INSTANCE.play("Perfume_globalsite_sound",1,true)});AudioMixer.INSTANCE.reserve(["Perfume_globalsite_sound"])});function setupFileList(c){var a=$("#searchPanel ul");var b=["aachan.bvh","kashiyuka.bvh","nocchi.bvh","07_05.amc","09_06.amc","79_96.amc","111_7.amc","131_04.amc","135_06.amc"];b.forEach(function(f){var e=$("<a></a>").text(f);var d=$("<li></li>").append(e);d.attr("data-filtertext",f);a.append(d);e.click(function(){c.loadMotion(f+".json")})});a.filterable("refresh")};