Math.PI2=Math.PI2||Math.PI*2;Math.SQ=Math.SQ||Math.PI/2;Math.trim=Math.trim||function(b){var a=b;while(Math.PI<a){a-=Math.PI2}while(a<-Math.PI){a+=Math.PI2}return a};Math.close=Math.close||function(d,c,b){var a=Math.trim(d-c);if(Math.abs(a)<=b){return d}if(0<a){return d-b}return d+b};function Matrix(a){this.mat=a}Matrix.NO_EFFECT=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];Matrix.rotateX=function(a){return new Matrix([[1,0,0,0],[0,Math.cos(a),-Math.sin(a),0],[0,Math.sin(a),Math.cos(a),0],[0,0,0,1]])};Matrix.rotateY=function(a){return new Matrix([[Math.cos(a),0,Math.sin(a),0],[0,1,0,0],[-Math.sin(a),0,Math.cos(a),0],[0,0,0,1]])};Matrix.rotateZ=function(a){return new Matrix([[Math.cos(a),-Math.sin(a),0,0],[Math.sin(a),Math.cos(a),0,0],[0,0,1,0],[0,0,0,1]])};Matrix.prototype.multiply=function(c){var b=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];var a=c.mat;this.mat.forEach(function(e,d){e.forEach(function(g,f){var i=0;for(var h=0;h<4;h++){i+=e[h]*a[h][f]}b[d][f]=i})});return new Matrix(b)};Matrix.prototype.affine=function(c,g,e){var b=this.mat;var a=b[0][0]*c+b[0][1]*g+b[0][2]*e+b[0][3];var f=b[1][0]*c+b[1][1]*g+b[1][2]*e+b[1][3];var d=b[2][0]*c+b[2][1]*g+b[2][2]*e+b[2][3];return{x:a,y:f,z:d}};function Skeleton(a){this.data=a;this.map={};this.offsetX=0;this.offsetY=0;this.rotationH=Math.PI/4;this.rotationV=Math.PI/8;this.rotationMatrix=new Matrix(Matrix.NO_EFFECT);this.init()}Skeleton.prototype.init=function(){var a=Object.assign(new Bone(),this.data.root);this.data.root=a;this.prepare(a);this.calcRotationMatrix()};Skeleton.prototype.prepare=function(b){var c=this;var a=[];b.prepare();b.joint.forEach(function(d){d.parent=b;a.push(Object.assign(new Bone(),d))});b.joint=a;b.joint.forEach(function(d){c.prepare(d)});b.skeleton=this;this.map[b.name]=b};Skeleton.prototype.calcRotationMatrix=function(){var a=Matrix.rotateY(this.rotationH);this.rotationMatrix=Matrix.rotateX(this.rotationV).multiply(a)};Skeleton.prototype.rotateH=function(a){this.rotationH+=(Math.PI/720)*a;this.rotationH=Math.trim(this.rotationH);this.calcRotationMatrix()};Skeleton.prototype.rotateV=function(a){this.rotationV+=(Math.PI/720)*a;this.rotationV=Math.trim(this.rotationV);this.calcRotationMatrix()};Skeleton.prototype.shift=function(a,c){var b=this;a.forEach(function(n){var d=n.r;var m=b.map[n.name];var g=Matrix.rotateX(d.x);var f=Matrix.rotateY(d.y);var e=Matrix.rotateZ(d.z);m.motionMatrix=e.multiply(f).multiply(g);if(n.p){var h=n.p;var i=m.pt;var l=b.offsetX+i.x+h.x*c;var k=b.offsetY+i.y+h.y*c;var j=i.z+h.z*c;m.translateMatrix=new Matrix([[1,0,0,l],[0,1,0,k],[0,0,1,j],[0,0,0,1]])}})};Skeleton.prototype.calculate=function(a){this.data.root.calculate(a)};Skeleton.prototype.draw=function(a){this.data.root.draw(a)};function Bone(){this.pt={x:0,y:0,z:0}}Bone.prototype.prepare=function(){var j=this.translate;var i=Matrix.rotateX(this.axis.x);var g=Matrix.rotateY(this.axis.y);var f=Matrix.rotateZ(this.axis.z);var e=f.multiply(g).multiply(i);this.translateMatrix=new Matrix([[1,0,0,j.x],[0,1,0,j.y],[0,0,1,j.z],[0,0,0,1]]);if(this.parent){var h=this.parent;var c=Matrix.rotateX(-h.axis.x);var b=Matrix.rotateY(-h.axis.y);var a=Matrix.rotateZ(-h.axis.z);var d=c.multiply(b).multiply(a);this.axisMatrix=d.multiply(e)}else{this.axisMatrix=e}this.motionMatrix=new Matrix(Matrix.NO_EFFECT)};Bone.prototype.getAccum=function(){if(this.parent){var a=this.axisMatrix.multiply(this.motionMatrix).multiply(this.translateMatrix);return this.parent.getAccum().multiply(a)}return this.translateMatrix.multiply(this.motionMatrix)};Bone.prototype.calculate=function(a){this.pt=this.getAccum().affine(0,0,0);if(a){return}this.joint.forEach(function(b){b.calculate(false)})};Bone.prototype.drawLine=function(g){var d=this.parent.pt;var j=this.pt;var c=this.skeleton.rotationMatrix;d=c.affine(d.x,d.y,d.z);j=c.affine(j.x,j.y,j.z);var i=j.x;var f=-j.y;var b=d.x;var a=-d.y;var h=i-b;var e=f-a;this.cx=b+h/2;this.cy=a+e/2;this.cz=j.z;this.radian=Math.atan2(e,h);g.beginPath();g.moveTo(b,a);g.lineTo(i,f);g.stroke()};Bone.prototype.draw=function(a){this.calculate();if(this.parent){this.drawLine(a)}this.joint.forEach(function(b){b.draw(a)})};function Field(){this.motionNo=0;this.init()}Field.prototype.init=function(){var a=document.getElementById("canvas");this.ctx=a.getContext("2d");this.loadAsf()};Field.prototype.resetCanvas=function(a){this.width=a;this.height=a;this.hW=this.width/2;this.hH=this.height/2;$("#canvas").attr("width",this.width).attr("height",this.height)};Field.prototype.loadAsf=function(){var a=this;return $.ajax("dat/asf.json",{dataType:"json",success:function(b){a.skeleton=new Skeleton(b)}})};Field.prototype.loadMotion=function(a){var c=this;var b=$("#slider");c.shiftMotion(0);b.val(0).slider("refresh");return $.ajax("dat/"+a,{dataType:"json",success:function(d){c.motion=d;c.resetMotion();b.prop("max",c.motion.length-1);b.slider("refresh")}})};Field.prototype.resetMotion=function(){this.skeleton.shift(this.motion[this.motionNo],1);this.skeleton.calculate();this.draw()};Field.prototype.shiftMotion=function(a){var b=a<this.motionNo?-1:1;while(this.motionNo!=a){this.motionNo+=b;this.skeleton.shift(this.motion[this.motionNo],b);this.skeleton.calculate(this.motionNo!=a)}};Field.prototype.nextMotion=function(a){if(!this.motion){return}var a=this.motionNo;a++;if(this.motion.length<=a){a=0}this.shiftMotion(a)};Field.prototype.rotateH=function(a){if(!this.skeleton){return}this.skeleton.rotateH(a)};Field.prototype.rotateV=function(a){if(!this.skeleton){return}this.skeleton.rotateV(a)};Field.prototype.draw=function(){if(!this.skeleton){return}var a=this.ctx;a.clearRect(0,0,this.width,this.height);a.save();a.strokeText("H:"+Math.floor(this.skeleton.rotationH*180/Math.PI),2,20);a.strokeText("V:"+Math.floor(this.skeleton.rotationV*180/Math.PI),2,30);a.strokeText("m:"+this.motionNo,2,40);a.translate(this.hW,this.hH);a.scale(5,5);a.lineCap="round";this.skeleton.draw(a);a.restore()};document.addEventListener("DOMContentLoaded",function(){var j=$("#view");var c=$("#slider");var k=new Field();var f=0;var d=0;var h=0;var a=function(){var m=$("body");var p=$("#header");var o=$("#footer");var l=m.height()-p.outerHeight(true)-o.outerHeight(true)-20;var n=Math.min(m.width(),l);k.resetCanvas(n)};var b=function(n){var l=n.type.match(/^mouse/);if(l){f=n.pageX;d=n.pageY}else{if(n.originalEvent.touches){var m=n.originalEvent.touches[0];f=m.pageX;d=m.pageY}}h=n.which};var i=function(r){var o=r.type.match(/^mouse/);var m;var l;if(o){if(!h){return}m=r.pageX;l=r.pageY}else{if(r.originalEvent.touches){var q=r.originalEvent.touches[0];m=q.pageX;l=q.pageY}}var p=f-m;var n=d-l;k.rotateH(p);k.rotateV(n);f=m;d=l};var e=function(l){h=0};var g=function(){k.draw();setTimeout(g,33)};setupFileList(k);j.mousedown(b);j.mousemove(i);j.mouseleave(e);j.mouseup(e);j.bind("touchstart",b);j.bind("touchmove",i);j.bind("touchend",e);c.change(function(){k.shiftMotion($(this).val())});$(window).resize(a);g();$(window).resize()});function setupFileList(c){var a=$("#searchPanel ul");var b=["07_05.amc","09_06.amc","79_96.amc","111_7.amc","131_04.amc","135_06.amc"];b.forEach(function(f){var e=$("<a></a>").text(f);var d=$("<li></li>").append(e);d.attr("data-filtertext",f);a.append(d);e.click(function(){c.loadMotion(f+".json")})});a.filterable("refresh")};